name: CI Watchdog

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  report:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Open issue on CI failure
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const { owner, repo } = context.repo;
            const title = `CI failed: ${run.name} @ ${run.head_branch} (${run.id})`;
            const body = [
              `CI failed for commit ${run.head_sha} on branch \`${run.head_branch}\`.`,
              ``,
              `Run: ${run.html_url}`,
              `Actor: @${run.actor.login}`,
              ``,
              `This issue was opened automatically by CI Watchdog.`,
            ].join("\n");
            await github.rest.issues.create({ owner, repo, title, body, labels: ["ci-failure"], assignees: ["Dhruv2mars"] });

